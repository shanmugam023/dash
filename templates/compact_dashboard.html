{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Compact Header -->
    <div class="row align-items-center mb-3 pt-2">
        <div class="col">
            <h4 class="fw-bold text-white mb-0">Trading Dashboard</h4>
            <small class="text-muted">Real-time trading analytics</small>
        </div>
        <div class="col-auto">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-light btn-sm active" onclick="filterPeriod('today')">Today</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('week')">Week</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('month')">Month</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('year')">Year</button>
            </div>
            <a href="/logs" class="btn btn-outline-info btn-sm ms-2">
                <i class="fas fa-file-alt"></i> Logs
            </a>
        </div>
    </div>

    <!-- Compact Metrics Row -->
    <div class="row g-2 mb-3">
        <div class="col-6 col-md-3">
            <div class="card phoenix-card bg-success bg-opacity-10 border-success border-opacity-25">
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h6 class="fw-bold text-success mb-0">{{ (yuva_stats.long_trades or 0) + (shan_stats.long_trades or 0) }}</h6>
                            <small class="text-success-emphasis">Long</small>
                        </div>
                        <i class="fas fa-arrow-up text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card phoenix-card bg-warning bg-opacity-10 border-warning border-opacity-25">
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h6 class="fw-bold text-warning mb-0">{{ (yuva_stats.short_trades or 0) + (shan_stats.short_trades or 0) }}</h6>
                            <small class="text-warning-emphasis">Short</small>
                        </div>
                        <i class="fas fa-arrow-down text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card phoenix-card bg-info bg-opacity-10 border-info border-opacity-25">
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h6 class="fw-bold text-info mb-0">{{ trading_summary.live_trades_success or 0 }}</h6>
                            <small class="text-info-emphasis">Success</small>
                        </div>
                        <i class="fas fa-check text-info"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card phoenix-card bg-danger bg-opacity-10 border-danger border-opacity-25">
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h6 class="fw-bold text-danger mb-0">{{ trading_summary.live_trades_failure or 0 }}</h6>
                            <small class="text-danger-emphasis">Failed</small>
                        </div>
                        <i class="fas fa-times text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Status Row -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card phoenix-card">
                <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-3">
                            <div class="text-center">
                                <div class="badge {{ 'bg-success' if trading_summary.buy_container_running else 'bg-secondary' }} mb-1">
                                    BUY {{ 'ON' if trading_summary.buy_container_running else 'OFF' }}
                                </div>
                                <div><small class="text-muted">Container</small></div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center">
                                <div class="badge {{ 'bg-success' if trading_summary.sell_container_running else 'bg-secondary' }} mb-1">
                                    SELL {{ 'ON' if trading_summary.sell_container_running else 'OFF' }}
                                </div>
                                <div><small class="text-muted">Container</small></div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center">
                                <div class="badge {{ 'bg-success' if trading_summary.api_enabled else 'bg-warning' }} mb-1">
                                    API {{ 'ON' if trading_summary.api_enabled else 'OFF' }}
                                </div>
                                <div><small class="text-muted">Status</small></div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-center">
                                <div class="badge {{ 'bg-success' if trading_summary.status == 'active' else 'bg-secondary' }} mb-1">
                                    {{ trading_summary.status|upper }}
                                </div>
                                <div><small class="text-muted">System</small></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-2 mb-3">
        <div class="col-md-8">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0 p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-white">Historical Performance</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-phoenix-secondary active" onclick="loadHistoricalData('daily')">Daily</button>
                            <button class="btn btn-phoenix-secondary" onclick="loadHistoricalData('weekly')">Weekly</button>
                            <button class="btn btn-phoenix-secondary" onclick="loadHistoricalData('monthly')">Monthly</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-2">
                    <canvas id="historicalChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0 p-2">
                    <h6 class="mb-0 text-white">Success Rate</h6>
                </div>
                <div class="card-body p-2">
                    <canvas id="successRateChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Reader Summary -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0 p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-white">Log Reader Data</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshLogData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2 text-center" id="logReaderStats">
                        <div class="col-3">
                            <div class="text-white fw-bold" id="buySuccess">-</div>
                            <small class="text-muted">Buy Success</small>
                        </div>
                        <div class="col-3">
                            <div class="text-white fw-bold" id="sellSuccess">-</div>
                            <small class="text-muted">Sell Success</small>
                        </div>
                        <div class="col-3">
                            <div class="text-white fw-bold" id="buyTracking">-</div>
                            <small class="text-muted">Buy Tracking</small>
                        </div>
                        <div class="col-3">
                            <div class="text-white fw-bold" id="sellTracking">-</div>
                            <small class="text-muted">Sell Tracking</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Trades Table (Compact) -->
    <div class="row">
        <div class="col-12">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0 p-2">
                    <h6 class="mb-0 text-white">Recent Trades</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Price</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in recent_trades[:10] %}
                                <tr>
                                    <td class="text-muted small">{{ trade.created_at.strftime('%H:%M') }}</td>
                                    <td>{{ trade.user }}</td>
                                    <td>{{ trade.symbol }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if trade.side == 'LONG' else 'warning' }} badge-sm">
                                            {{ trade.side }}
                                        </span>
                                    </td>
                                    <td>${{ "%.4f"|format(trade.entry_price) }}</td>
                                    <td class="text-{{ 'success' if trade.pnl >= 0 else 'danger' }}">
                                        ${{ "%.2f"|format(trade.pnl) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let historicalChart;
let successRateChart;

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadHistoricalData('daily');
    refreshLogData();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        refreshLogData();
        loadHistoricalData('daily');
    }, 30000);
});

function initializeCharts() {
    // Historical performance chart
    const ctx1 = document.getElementById('historicalChart').getContext('2d');
    if (typeof Chart !== 'undefined') {
        historicalChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Success',
                data: [],
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.1
            }, {
                label: 'Failures',
                data: [],
                borderColor: 'rgb(239, 68, 68)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: 'white', boxWidth: 15 }
                }
            },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });

    // Success rate chart
    const ctx2 = document.getElementById('successRateChart').getContext('2d');
    if (typeof Chart !== 'undefined') {
        successRateChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Success', 'Failed'],
            datasets: [{
                data: [0, 0],
                backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: 'white', boxWidth: 15 }
                }
            }
        }
    });
    } else {
        console.log('Chart.js not loaded, skipping success rate chart');
    }
}

function loadHistoricalData(period) {
    fetch(`/api/historical-log-data?period=${period}`)
        .then(response => response.json())
        .then(data => {
            const labels = data.map(d => d.date);
            const successData = data.map(d => d.buy_success + d.sell_success);
            const failureData = data.map(d => d.buy_failures + d.sell_failures);
            
            historicalChart.data.labels = labels;
            historicalChart.data.datasets[0].data = successData;
            historicalChart.data.datasets[1].data = failureData;
            historicalChart.update();
            
            // Update success rate chart with latest data
            if (data.length > 0) {
                const latest = data[data.length - 1];
                const totalSuccess = latest.buy_success + latest.sell_success;
                const totalFailure = latest.buy_failures + latest.sell_failures;
                
                successRateChart.data.datasets[0].data = [totalSuccess, totalFailure];
                successRateChart.update();
            }
        })
        .catch(error => console.error('Error loading historical data:', error));

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function refreshLogData() {
    fetch('/api/trading-summary')
        .then(response => response.json())
        .then(data => {
            // Update log reader stats (placeholder - you'll need to add the actual data from log parsing)
            document.getElementById('buySuccess').textContent = data.live_trades_success || 0;
            document.getElementById('sellSuccess').textContent = data.live_trades_failure || 0;
            document.getElementById('buyTracking').textContent = '-';
            document.getElementById('sellTracking').textContent = '-';
        })
        .catch(error => console.error('Error refreshing log data:', error));
}

function filterPeriod(period) {
    // Implement period filtering logic
    console.log('Filtering by period:', period);
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}
</script>
{% endblock %}