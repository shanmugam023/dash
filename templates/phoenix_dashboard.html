{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block content %}
<!-- Header with Trading Overview -->
<div class="container-fluid px-4">
    <div class="row align-items-center mb-4 pt-3">
        <div class="col">
            <h2 class="fw-bold text-white mb-1">Trading Dashboard</h2>
            <p class="text-muted mb-0">Here's what's happening with your trades right now</p>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-light btn-sm active" onclick="filterPeriod('today')">Today</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('week')">Week</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('month')">Month</button>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="filterPeriod('year')">Year</button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-xl-3">
            <div class="card phoenix-card bg-success bg-opacity-10 border-success border-opacity-25">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h4 class="fs-4 fw-bold text-success mb-0">{{ (yuva_stats.long_trades or 0) + (shan_stats.long_trades or 0) }}</h4>
                            <p class="text-success-emphasis mb-0 fs-7">Long positions</p>
                        </div>
                        <div class="ms-2">
                            <div class="icon-circle bg-success bg-opacity-25">
                                <i class="fas fa-arrow-trend-up text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-xl-3">
            <div class="card phoenix-card bg-warning bg-opacity-10 border-warning border-opacity-25">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h4 class="fs-4 fw-bold text-warning mb-0">{{ (yuva_stats.short_trades or 0) + (shan_stats.short_trades or 0) }}</h4>
                            <p class="text-warning-emphasis mb-0 fs-7">Short positions</p>
                        </div>
                        <div class="ms-2">
                            <div class="icon-circle bg-warning bg-opacity-25">
                                <i class="fas fa-arrow-trend-down text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-xl-3">
            <div class="card phoenix-card bg-danger bg-opacity-10 border-danger border-opacity-25">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h4 class="fs-4 fw-bold text-danger mb-0">{{ (yuva_stats.failed_trades or 0) + (shan_stats.failed_trades or 0) }}</h4>
                            <p class="text-danger-emphasis mb-0 fs-7">Failed trades</p>
                        </div>
                        <div class="ms-2">
                            <div class="icon-circle bg-danger bg-opacity-25">
                                <i class="fas fa-times-circle text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-xl-3">
            <div class="card phoenix-card bg-info bg-opacity-10 border-info border-opacity-25">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <h4 class="fs-4 fw-bold text-info mb-0">${{ "%.0f"|format((yuva_stats.total_pnl or 0) + (shan_stats.total_pnl or 0)) }}</h4>
                            <p class="text-info-emphasis mb-0 fs-7">Total P&L</p>
                        </div>
                        <div class="ms-2">
                            <div class="icon-circle bg-info bg-opacity-25">
                                <i class="fas fa-dollar-sign text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
        <!-- Long vs Short Performance Chart -->
        <div class="col-xxl-8">
            <div class="card phoenix-card h-100">
                <div class="card-header bg-transparent border-bottom-0 pb-0">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-1 text-white">Long vs Short Performance</h5>
                            <p class="fs-7 text-muted mb-0">Profit and loss comparison across position types</p>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-phoenix-secondary active" type="button">Completed</button>
                                <button class="btn btn-phoenix-secondary" type="button">Pending</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="longShortChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Performance Summary -->
        <div class="col-xxl-4">
            <div class="card phoenix-card h-100">
                <div class="card-header bg-transparent border-bottom-0 pb-0">
                    <h5 class="mb-1 text-white">Trading Summary</h5>
                    <p class="fs-7 text-muted mb-0">Last 7 days</p>
                </div>
                <div class="card-body">
                    <!-- Long Positions Summary -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-1">
                            <div class="d-flex align-items-center">
                                <div class="bullet-item bg-success me-2"></div>
                                <h6 class="text-white mb-0">Long positions</h6>
                            </div>
                            <p class="fs-7 text-muted mb-0">Success rate</p>
                        </div>
                        <div class="text-end">
                            {% set long_total = (yuva_stats.long_trades or 0) + (shan_stats.long_trades or 0) %}
                            {% set long_success = (yuva_stats.long_successful or 0) + (shan_stats.long_successful or 0) %}
                            {% if long_total > 0 %}
                                <h5 class="text-success mb-0">{{ "%.0f"|format(long_success / long_total * 100) }}%</h5>
                            {% else %}
                                <h5 class="text-success mb-0">0%</h5>
                            {% endif %}
                            <p class="fs-7 text-muted mb-0">{{ long_total }} trades</p>
                        </div>
                    </div>
                    
                    <!-- Short Positions Summary -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-1">
                            <div class="d-flex align-items-center">
                                <div class="bullet-item bg-warning me-2"></div>
                                <h6 class="text-white mb-0">Short positions</h6>
                            </div>
                            <p class="fs-7 text-muted mb-0">Success rate</p>
                        </div>
                        <div class="text-end">
                            {% set short_total = (yuva_stats.short_trades or 0) + (shan_stats.short_trades or 0) %}
                            {% set short_success = (yuva_stats.short_successful or 0) + (shan_stats.short_successful or 0) %}
                            {% if short_total > 0 %}
                                <h5 class="text-warning mb-0">{{ "%.0f"|format(short_success / short_total * 100) }}%</h5>
                            {% else %}
                                <h5 class="text-warning mb-0">0%</h5>
                            {% endif %}
                            <p class="fs-7 text-muted mb-0">{{ short_total }} trades</p>
                        </div>
                    </div>
                    
                    <!-- Overall Performance -->
                    <div class="d-flex align-items-center">
                        <div class="flex-1">
                            <div class="d-flex align-items-center">
                                <div class="bullet-item bg-info me-2"></div>
                                <h6 class="text-white mb-0">Overall performance</h6>
                            </div>
                            <p class="fs-7 text-muted mb-0">Total win rate</p>
                        </div>
                        <div class="text-end">
                            {% set total_trades = (yuva_stats.total_trades or 0) + (shan_stats.total_trades or 0) %}
                            {% set total_success = (yuva_stats.successful_trades or 0) + (shan_stats.successful_trades or 0) %}
                            {% if total_trades > 0 %}
                                <h5 class="text-info mb-0">{{ "%.0f"|format(total_success / total_trades * 100) }}%</h5>
                            {% else %}
                                <h5 class="text-info mb-0">0%</h5>
                            {% endif %}
                            <p class="fs-7 text-muted mb-0">{{ total_trades }} trades</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Positions Table -->
    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-1 text-white">Current Positions</h5>
                            <p class="fs-7 text-muted mb-0">Active trading positions with real-time P&L</p>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-phoenix-secondary active" type="button">All positions</button>
                                <button class="btn btn-phoenix-secondary" type="button">Profitable</button>
                                <button class="btn btn-phoenix-secondary" type="button">Losing</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-0">
                    {% if current_positions %}
                    <div class="table-responsive">
                        <table class="table table-sm phoenix-table">
                            <thead class="bg-transparent">
                                <tr>
                                    <th class="white-space-nowrap ps-0 border-top-0">Symbol</th>
                                    <th class="white-space-nowrap border-top-0">Trader</th>
                                    <th class="white-space-nowrap border-top-0">Side</th>
                                    <th class="white-space-nowrap border-top-0">Entry Price</th>
                                    <th class="white-space-nowrap border-top-0">Size</th>
                                    <th class="white-space-nowrap border-top-0">P&L</th>
                                    <th class="white-space-nowrap border-top-0">Status</th>
                                    <th class="white-space-nowrap border-top-0 pe-0">Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for position in current_positions %}
                                <tr class="btn-reveal-trigger">
                                    <td class="ps-0 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-xs">
                                                <div class="avatar-name rounded-circle bg-primary-subtle text-primary">
                                                    {{ position.symbol[:2] }}
                                                </div>
                                            </div>
                                            <div class="ms-2">
                                                <h6 class="mb-0 fw-semibold text-white">{{ position.symbol }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge badge-phoenix fs-8 badge-phoenix-{% if position.user == 'Yuva' %}primary{% else %}secondary{% endif %}">
                                            {{ position.user }}
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge badge-phoenix fs-8 badge-phoenix-{% if position.side == 'LONG' %}success{% else %}warning{% endif %}">
                                            {{ position.side }}
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        <span class="text-white font-monospace">${{ "%.4f"|format(position.entry_price) }}</span>
                                    </td>
                                    <td class="py-3">
                                        <span class="text-muted font-monospace">{{ "%.2f"|format(position.position_size) }}</span>
                                    </td>
                                    <td class="py-3">
                                        <span class="fw-bold {% if position.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if position.pnl >= 0 %}+{% endif %}${{ "%.2f"|format(position.pnl) }}
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge badge-phoenix fs-8 badge-phoenix-info">OPEN</span>
                                    </td>
                                    <td class="py-3 pe-0">
                                        <span class="text-muted fs-7">{{ position.created_at }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="icon-circle bg-light-subtle mx-auto mb-3">
                            <i class="fas fa-chart-line text-muted fa-2x"></i>
                        </div>
                        <h6 class="text-white">No Active Positions</h6>
                        <p class="text-muted mb-0">All positions are currently closed</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Bots Status -->
    <div class="row g-3">
        <div class="col-12">
            <div class="card phoenix-card">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-1 text-white">Trading Bots Status</h5>
                    <p class="fs-7 text-muted mb-0">Monitor your automated trading systems</p>
                </div>
                <div class="card-body pt-0">
                    <div class="row g-3">
                        <div class="col-sm-6 col-lg-4">
                            <div class="card bg-success bg-opacity-10 border-success border-opacity-25 h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator status-running me-2"></div>
                                        <div class="flex-1">
                                            <h6 class="text-success mb-1">Yuva Trading Bot</h6>
                                            <p class="fs-7 text-success-emphasis mb-0">Running • Active positions: {{ (yuva_stats.long_trades or 0) + (yuva_stats.short_trades or 0) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="card bg-success bg-opacity-10 border-success border-opacity-25 h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator status-running me-2"></div>
                                        <div class="flex-1">
                                            <h6 class="text-success mb-1">Shan Trading Bot</h6>
                                            <p class="fs-7 text-success-emphasis mb-0">Running • Active positions: {{ (shan_stats.long_trades or 0) + (shan_stats.short_trades or 0) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="card bg-info bg-opacity-10 border-info border-opacity-25 h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator status-running me-2"></div>
                                        <div class="flex-1">
                                            <h6 class="text-info mb-1">Log Processor</h6>
                                            <p class="fs-7 text-info-emphasis mb-0">Processing • Last update: {{ "now"|replace("now", "2 minutes ago") }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Phoenix-style charts
document.addEventListener('DOMContentLoaded', function() {
    initializePhoenixCharts();
});

function initializePhoenixCharts() {
    // Long vs Short Performance Chart
    const longShortCtx = document.getElementById('longShortChart');
    if (longShortCtx) {
        new Chart(longShortCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [
                    {
                        label: 'Long Positions P&L',
                        data: [30, 45, 35, 60, 55, 70, 65],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#28a745',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Short Positions P&L',
                        data: [20, 25, 30, 35, 25, 40, 45],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ffc107',
                        pointBorderColor: '#ffc107',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    }
                }
            }
        });
    }
}

// Filter functions
function filterPeriod(period) {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    console.log('Filtering by period:', period);
    // Add AJAX call to fetch filtered data here
}

// Auto-refresh data
setInterval(function() {
    location.reload();
}, 60000); // Refresh every minute
</script>
{% endblock %}